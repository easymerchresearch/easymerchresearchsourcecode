window.addEventListener("load",function(){(async function(){try{document.querySelector(".close-btn").onclick=C,document.querySelector("#onImButton").src=(e="logo",chrome.runtime.getURL(`assets/images/${e}.png`)),document.querySelector("#onImButton").addEventListener("click",function(){S()})}catch(e){}var e})(),async function(){if(!await new Promise((e,t)=>{chrome.runtime.sendMessage({action:"gls"},n=>chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):void e(n?.active||!1))}))return;await d(5e3),await async function(){const e=document.getElementById("scroll-container"),t=document.querySelector(".easy-merch-research-main");e&&(e.style.height=window.innerHeight+"px"),t&&(t.style.height=window.innerHeight+"px")}(),0<a.length&&(p(),g()),function(){try{document.getElementById("csvFile").addEventListener("change",function(e){if((e=e.target.files)&&0!==e.length){var t=[];Promise.all(Array.from(e).map(e=>new Promise((t,n)=>{const r=new FileReader;r.onload=function(r){if(r=r.target.result,e.name.endsWith(".csv")){var o=function(e){try{return e.trim().split("\n").map(e=>({title:(e=e.split(",").map(e=>e.trim()))[0]||"",date:e[1]||"",bsr:e[2]||"",price:e[3]||"",asin:e[4]||"",ahref:e[5]||"",img:e[6]||""})).filter(e=>null!==e)}catch(e){}}(r);t(o)}else if(e.name.endsWith(".json"))try{o=JSON.parse(r),t(o)}catch(t){n(`Invalid JSON format in file: ${e.name}`)}else n(`Unsupported file type: ${e.name}`)},r.onerror=e=>n(e),r.readAsText(e)}))).then(e=>{e.forEach(e=>t.push(...e)),a=t,c=[],p(),g()}).catch(e=>console.error("Reading files failed!",e))}})}catch(e){console.error("Setting CSV Event Failed!",e)}}()}()}),document.querySelector(".fltrPannel").addEventListener("click",function(){S()}),document.querySelector(".deleteBtn").addEventListener("click",function(){b(1)}),document.querySelector(".loadBtn").addEventListener("click",function(){b(0)}),document.querySelector(".export").addEventListener("click",function(){!function(){const e=document.getElementById("export-options");e.style.display="block"===e.style.display?"none":"block"}()}),document.querySelector(".exportCSV").addEventListener("click",function(){!async function(){try{const e=0===c.length,t=e?a:c;!t||1>t.length?A("warning","Attention!","No Products To Export."):A("confirm","Export Producst?",e?"Export all products?":"Export filtered products?",async function(e){if(e){for(var n of(e=[],t))if(n.img&&10<n.img.length){var r=[I(n.title),I(n.date),I(n.bsr),I(n.price),I(n.asin),I(n.ahref),I(n.img)];e.push(r.join(","))}if(0<e.length)for(n=0;n<e.length;n+=5e4)r=e.slice(n,n+5e4).join("\n"),r=new Blob([r],{type:"text/csv;charset=utf-8"}),r=URL.createObjectURL(r),chrome.runtime.sendMessage({action:"downloadCSV",url:r,filename:`table-data-part${Math.floor(n/5e4)+1}.csv`});else A("warning","Attention!","No valid product data to export.")}})}catch(e){}}()}),document.querySelector(".exportJSON").addEventListener("click",function(){!function(){try{var e=0===c.length,t=e?a:c;!t||1>t.length?A("warning","Attention!","No Products To Export."):A("confirm","Export Producst?",e?"Export all products?":"Export filtered products?",async function(e){if(e)if(Array.isArray(t)&&0!==t.length){t=JSON.stringify(t,null,2),t=new Blob([t],{type:"application/json"});var n=document.createElement("a");n.href=URL.createObjectURL(t),n.download="products.json",document.body.appendChild(n),n.click(),document.body.removeChild(n)}else A("warning","Attention!","No valid product data to export.")})}catch(e){}}()}),document.addEventListener("click",function(e){const t=document.getElementById("export-options");document.querySelector(".export-container").contains(e.target)||(t.style.display="none")}),document.addEventListener("click",function(e){let t=e.target.className;switch(e.target.id||t){case"filterBtn":!async function(){var e=0;try{!a||1>a.length?A("warning","Attention!","No Products To Filter, Import Them First!"):A("confirm","Apply Filters?","",async function(t){if(t){c=[],document.querySelector("#scroll-container #virtual-list").innerHTML="",t=await x(document.getElementById("minDate").value||"01/01/2000",1);var n=await x(document.getElementById("maxDate").value||"12/12/3000",1),i=parseFloat(document.getElementById("minBsr").value)||0,s=parseFloat(document.getElementById("maxBsr").value)||1e9,l=parseFloat(document.getElementById("minfPrice").value)||0,u=parseFloat(document.getElementById("maxfPrice").value)||55,m=document.getElementById("filterTerm").value.toUpperCase();r=(document.querySelector("textarea#exclude-term.search-input")?.value||"").toUpperCase(),o=[...new Set(r.split(",").map(e=>e.trim()).filter(e=>e))];for(let r=0;r<a.length;r++)try{var y=a[r].title?a[r].title.toUpperCase():"",f=a[r].brand?a[r].brand.toUpperCase():"",h=await x(a[r].date.trim(),0),b=parseFloat(a[r].price.replace(/[^\d\.]/g,"")),v=parseFloat(a[r].bsr.replace(/[^\d\.]/g,"")),w=0<o.length&&o.some(e=>y.includes(e)),E=0<o.length&&o.some(e=>f.includes(e)),S=!1;parseInt(h)>=parseInt(t)&&!w&&!E&&parseInt(h)<=parseInt(n)&&-1<y.indexOf(m)&&b>=l&&b<=u&&(0==i&&1e9==s||(0!=i||1e9!=s)&&"number"==typeof v&&v>=i&&v<=s)&&(S=!0),S&&c.push(a[r]),100==++e&&(await d(10),e=0)}catch(t){console.error("Filter Data Error: ",t)}p(),g(),A("success",0<c.length?c.length+" products found!":"No Product Found!","")}})}catch(e){}}();break;case"clearBtn":!async function(){try{!c||1>c.length?A("warning","Attention!","No Filtred Products To Clear!"):A("confirm","Clear Filters","",function(e){e&&(c=[],p(),g())})}catch(e){}}()}});let e=!1,t=!1,n="desc",r="",o=null,c=[],a=[];const i=5,s=document.getElementById("scroll-container"),l=document.getElementById("virtual-list"),d=e=>new Promise(t=>setTimeout(t,e));function u(e,t="asc"){try{const n=0===c.length?a:c;if(!Array.isArray(n)||0===n.length)return;if(!["bsr","date","price","bsr+date","reviews"].includes(e))return;const r="asc"===t,o=e=>{if(null==e)return null;const t=e.toString().replace(/[^0-9.]/g,""),n=parseFloat(t);return isNaN(n)?null:n},i=e=>{const t=new Date(e).getTime();return isNaN(t)?null:t};n.forEach(e=>{e._bsr=o(e.bsr),e._price=o(e.price),e._date=i(e.date),e._reviews=o(e.reviews)}),n.sort((t,n)=>{if("bsr+date"===e){const e=t._bsr,o=n._bsr,c=null!==e,a=null!==o;if(c&&!a)return-1;if(!c&&a)return 1;const i=t._date,s=n._date;return null!==i&&null!==s&&i!==s?s-i:c&&a&&e!==o?r?e-o:o-e:0}let o,c;switch(e){case"bsr":o=t._bsr,c=n._bsr;break;case"price":o=t._price,c=n._price;break;case"date":o=t._date,c=n._date;break;case"reviews":o=t._reviews,c=n._reviews;break;default:o=null,c=null}return null===o&&null===c?0:null===o?1:null===c?-1:r?o-c:c-o}),0===c.length?a=n:c=n,g()}catch(e){console.error("Error in sortLoadedProducts:",e)}}function m(){return Math.floor(s.clientWidth/250)}function p(){const e=m();l.style.height=450*Math.ceil((0<c.length?c.length:a.length)/e)+"px"}function y(e){try{const o=0===c.length?a:c,i=document.createElement("div");i.classList.add("card"),i.setAttribute("data-index",e);let s=null;if(o)if(o[e]){var t=0,n=15,r=1.8;if(o[e]&&o[e].title)switch(!0){case o[e].title.endsWith("Tank Top"):t=0,n=-35,r=1.5;break;case o[e].title.endsWith("Premium T-Shirt"):t=-3,n=10,r=1.9;break;case o[e].title.endsWith("V-Neck T-Shirt"):t=0,n=-10,r=1.8;break;case o[e].title.endsWith("Stainless Steel Insulated Tumbler"):t=0,n=-100,r=1;break;default:t=0,n=10,r=1.8}i.innerHTML=`\n\t\t\t\t\t<a href="${o[e].ahref||"#"}" target="_blank">\n\t\t\t\t\t<div class="img_container">\n\t\t\t\t\t\t\t<img src="${o[e].img||""}" alt="${o[e].title}" style="transform: translate3d(${t}px, ${n}px, 0);scale :${r}"/>\n\t\t\t\t\t</div>\n\t\t\t\t\t</a>\n\t\t\t\t\t<div class="details_container">\n                        <p>Title:<b class="title" data-title="${o[e].title||"N/A"}"> Copy title</b></p>\n\t\t\t\t\t\t<p>Date:<b class="date"> ${function(e){try{if(!e||e.includes("N/A"))return e;const t={Januar:"January",Februar:"February","März":"March",April:"April",Mai:"May",Juni:"June",Juli:"July",August:"August",September:"September",Oktober:"October",November:"November",Dezember:"December",janvier:"January","février":"February",mars:"March",avril:"April",mai:"May",juin:"June",juillet:"July","août":"August",septembre:"September",octobre:"October",novembre:"November","décembre":"December",enero:"January",febrero:"February",marzo:"March",abril:"April",mayo:"May",junio:"June",julio:"July",agosto:"August",septiembre:"September",octubre:"October",noviembre:"November",diciembre:"December",gennaio:"January",febbraio:"February",marzo:"March",aprile:"April",maggio:"May",giugno:"June",luglio:"July",agosto:"August",settembre:"September",ottobre:"October",novembre:"November",dicembre:"December","січня":"January","лютого":"February","березня":"March","квітня":"April","травня":"May","червня":"June","липня":"July","серпня":"August","вересня":"September","жовтня":"October","листопада":"November","грудня":"December"};for(const[n,r]of Object.entries(t)){const t=new RegExp(`\\b${n}\\b`,"i");if(t.test(e)){e=e.replace(t,r);break}}/^\w+ \d{1,2} \d{4}$/.test(e)&&(e=e.replace(/^(\w+ \d{1,2}) (\d{4})$/,"$1, $2"));const n=new Date(e);if(isNaN(n))throw new RangeError("Invalid Date");return new Intl.DateTimeFormat("en-US",{month:"long",day:"numeric",year:"numeric"}).format(n)}catch(t){return console.error("Error Converting Date:",t+" DATE: "+e),"N/A"}}(o[e].date)||"N/A"}</b></p>\n\t\t\t\t\t\t<p>Rank(BSR):<b class="bsr" ${k(o[e].bsr).includes("N/A")?'style="background: #6a9cc7;"':""}>${k(o[e].bsr)||"N/A"}</b></p>\n\t\t\t\t\t\t<p>Price:<b>${function(e){try{const t=e.replace(/\n/g,"").trim(),n=t.match(/([$\u20ac\u00a3])(\d+(\.\d{2})?)/);if(n)return`${n[1]}${n[2]}`;const r=t.match(/(\d+(\.\d{2})?)/);if(r)return r[0]}catch(e){}return null}(o[e].price)||"N/A"}</b></p>\n\t\t\t\t\t\t<p>Asin:<b>${o[e].asin||"N/A"}</b></p>\n\t\t\t\t\t</div>\n\t\t\t\t`,s=!0}else s=!1;return{card:i,answer:s}}catch(t){console.error("Creating Cards failed :",t)}}function f(e){try{if(e){var t=e?.getAttribute("data-title");navigator.clipboard.writeText(t).then(()=>{e.textContent="Title copied",setTimeout(()=>{e.textContent="Copy title"},2e3)}).catch(e=>{console.error("Failed to copy title:",e)})}}catch(t){}}function g(){try{var e=s.scrollTop;const n=m();var t=Math.max(0,Math.floor(e/450)*n-i*n);const r=Math.min(0<c.length?c.length:a.length,t+(Math.ceil(s.clientHeight/450)+10)*n);for(;l.firstChild;)l.removeChild(l.firstChild);const o=document.createDocumentFragment();for(e=t;e<r;e++){const r=y(e);(r.answer||!0===r.answer)&&(t=e%n,r.card.style.top=450*Math.floor(e/n)+"px",r.card.style.left=250*t+"px",r.card.querySelector(".title")?.addEventListener("click",()=>{f(r.card.querySelector(".title"))}),o.appendChild(r.card))}l.appendChild(o)}catch(e){}}async function h(){try{return new Promise(e=>{const t=chrome.runtime.connect({name:"TabId"});t.postMessage({action:"getActiveTabId"}),t.onMessage.addListener(n=>{n&&void 0!==n.tabId?e(n.tabId):e(null),t.disconnect()}),t.onDisconnect.addListener(()=>{})})}catch(e){}}async function b(e){try{const t=await h();if(t){const n=chrome.runtime.connect({name:"retreiveChannel"});n.postMessage({action:"storesInfo",tabId:t}),n.onMessage.addListener(t=>{"success"===t.status?function(e,t){try{if(e&&Array.isArray(e)){var n=document.createElement("div");n.id="storeInfoModal",n.style.position="fixed",n.style.left="0",n.style.top="0",n.style.width="100%",n.style.height="100%",n.style.backgroundColor="rgba(0, 0, 0, 0.5)",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.zIndex="1000",document.addEventListener("keydown",e=>{"Escape"===e.key&&document.body.removeChild(n)});var r=document.createElement("div");r.style.backgroundColor="rgb(41 41 41)",r.style.padding="20px 20px 20px 50px",r.style.borderRadius="8px",r.style.minWidth="450px",r.style.maxHeight="80%",r.style.overflowY="auto",r.style.position="relative";var o=document.createElement("span");o.innerHTML="&times;",o.style.position="absolute",o.style.top="10px",o.style.right="15px",o.style.cursor="pointer",o.style.fontSize="1.5em",o.onclick=()=>document.body.removeChild(n),r.appendChild(o);var c=document.createElement("h2");c.style.marginBottom="20px",c.textContent=0===e.length?"No Products Found!":"Select Products",r.appendChild(c);var a=document.createElement("div"),i=e.reduce((e,t)=>{const[,n,...r]=t.storeName.split("_"),o=r.join("_");return e[n]||(e[n]=[]),e[n].push({name:o,recordCount:t.recordCount,fullName:t.storeName}),e},{});for(const[e,n]of Object.entries(i)){const r=document.createElement("div");r.style="margin: 10px;width: 180px;float: left;";const o=document.createElement("h3");o.textContent=`${e} Products`,o.style.color="#228dff",r.appendChild(o),n.forEach(n=>{const o=document.createElement("div");o.textContent=`${n.name} (${n.recordCount})`,o.style.marginLeft="20px",o.style.padding="5px",o.style.color="#fff",o.style.cursor="pointer",o.onmouseover=()=>o.style.backgroundColor="#ddd",o.onmouseout=()=>o.style.background="none",o.onclick=0===t?()=>E(n.fullName,n.name.replace("_"," "),e):()=>w(n.fullName,n.name.replace("_"," "),e),r.appendChild(o)}),a.appendChild(r)}r.appendChild(a),n.appendChild(r),document.body.appendChild(n)}}catch(t){}}(t.message,e):A("warning","Error","failed To Get Stored Products!"),n.disconnect()}),n.onDisconnect.addListener(()=>{})}}catch(e){}}function v(){document.body.removeChild(document.querySelector("#storeInfoModal"))}function w(e,t,n){!async function(e,t,n){try{null===e?A("warning","Something went wrong.","try again!"):A("confirm",`Delete ${t}?`,`All ${t} In ${n} Market Will Be Deleted.`,async function(r){if(r&&(r=await h())){const o=chrome.runtime.connect({name:"data"});o.postMessage({action:"delete",storename:e,tabId:r}),o.onMessage.addListener(e=>{"success"===e.status?(v(),A("success","Great!",`${t} successfully deleted.`)):"noRecords"===e.status?A("warning","Error!",`No ${t} In ${n} Market to delete.`):A("warning","Error!",`Failed to delete ${t}.`),o.disconnect()}),o.onDisconnect.addListener(()=>{})}})}catch(t){}}(e,t,n)}function E(t,n,r){!async function(t,n,r){try{null===t?A("warning","Something went wrong.","try again!"):A("confirm",`Import ${n}?`,`You're about to import all ${n} from ${r} market.`,async function(o){if(o&&(o=await h())){const i=chrome.runtime.connect({name:"retreive"});i.postMessage({action:"retreiveData",asin:null,name:t,tabId:o}),i.onMessage.addListener(t=>{"success"===t.status?(v(),A("success","Great!",t.message.length+` ${n} successfully imported!`),a=t.message,c=[],a.reverse(),p(),g(),e=!0):"noRecords"===t.status?A("warning","Error",`No ${n} found in ${r} market!`):A("warning","Error",`Failed to import ${n} from ${r}!`),i.disconnect()}),i.onDisconnect.addListener(()=>{})}})}catch(n){}}(t,n,r)}async function x(e,t){try{if(0==t)try{const t=new Date(e);return`\n\t\t\t\t${t.getFullYear()}${(t.getMonth()+1).toString().padStart(2,"0")}${t.getDate().toString().padStart(2,"0")}`.replace(/[^\d\.]/g,"")}catch(t){return 0}if(1==t)return e.split("/")[2]+e.split("/")[0]+e.split("/")[1]}catch(t){}}async function S(){t?async function(){document.body.setAttribute("style","scrollbar-width: none; overflow: hidden"),document.querySelector(".easy-merch-research-main").style.display="",t=!1}():async function(){document.body.removeAttribute("style"),document.querySelector(".easy-merch-research-main").style.display="none",t=!0}()}function I(e){return e?e.replace(/,/g,"").replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069\u200B\u200C\u2028\u2029]/g,"").normalize("NFC").trim():null}function k(e){return"string"!=typeof e||""===e.trim()||isNaN(e.trim())||isNaN(e)||null==e?"N/A":"#"+(+e).toLocaleString()}function A(e,t,n,r){const o=document.getElementById("customAlert"),c=document.getElementById("alertTitle"),a=document.getElementById("alertMessage"),i=document.getElementById("alertIcon"),s=document.getElementById("confirmButtons"),l=document.getElementById("confirmBtn"),d=document.getElementById("cancelBtn");c.innerText=t,a.innerText=n,o.classList.remove("success","warning","confirm","announce"),s.style.display="none",o.classList.add(e),"success"===e?c.style.color="#74cf31":"warning"===e?(c.style.color="#ffa500",i.innerHTML="&#9888;"):"confirm"===e?(c.style.color="#228dff",i.innerHTML="",s.style="display: flex; flex-wrap: nowrap; justify-content: center;"):"announce"===e&&(c.style.color="#228dff",i.innerHTML=""),o.style.display="flex",l.onclick=()=>{C(),r&&r(!0)},d.onclick=()=>{C(),r&&r(!1)}}function C(){document.getElementById("customAlert").style.display="none"}document.querySelector(".easy-merch-research-container .products-sorts")?.addEventListener("click",e=>{const t=e.target.innerText.toLowerCase().trim();t&&function(e){n="asc"==n?"desc":"asc",e.includes("best sellers")?u("bsr+date"):e.includes("bsr")?u("bsr",n):e.includes("date")?u("date",n):u("price",n)}(t)}),s.addEventListener("scroll",g),window.addEventListener("resize",()=>{p(),g()}),document.querySelector(".import").addEventListener("click",function(){document?.getElementById("csvFile").click()}),document.querySelector("#importFiles").addEventListener("click",function(){document?.getElementById("csvFile").click()}),window.onclick=function(e){const t=document.getElementById("customAlert");e.target===t&&C()};